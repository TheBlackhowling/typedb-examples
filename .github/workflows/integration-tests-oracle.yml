name: Integration Tests - Oracle

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch: # Manual trigger also available (for re-running after fixes)

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout typedb-examples
        uses: actions/checkout@v4
        with:
          path: typedb-examples
      
      - name: Checkout typedb
        uses: actions/checkout@v4
        with:
          repository: TheBlackhowling/typedb
          path: typedb
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: typedb-examples/integration_tests/oracle/go.sum
      
      - name: Update go.mod replace directives
        working-directory: typedb-examples
        run: |
          # Update replace directives to point to checked-out typedb repo
          # From integration_tests/*/, typedb is at ../../../typedb (up 3 levels to workspace root, then into typedb)
          find integration_tests -name go.mod -exec sed -i 's|replace github.com/TheBlackHowling/typedb => ../..|replace github.com/TheBlackHowling/typedb => ../../../typedb|g' {} \;
      
      - name: Setup integration test dependencies
        working-directory: typedb-examples/integration_tests/oracle
        run: |
          go mod tidy
          go mod download
      
      - name: Try to pull Oracle image without authentication
        id: try_oracle_pull
        continue-on-error: true
        run: |
          docker pull container-registry.oracle.com/database/free:latest || exit 1
          echo "oracle_available=true" >> $GITHUB_OUTPUT
      
      - name: Check Oracle credentials (if pull failed)
        id: check_oracle
        if: steps.try_oracle_pull.outcome == 'failure'
        run: |
          if [ -z "${{ secrets.ORACLE_USERNAME }}" ] || [ -z "${{ secrets.ORACLE_PASSWORD }}" ]; then
            echo "oracle_available=false" >> $GITHUB_OUTPUT
            echo "Oracle image pull failed and credentials not configured. Skipping Oracle tests."
            echo "To enable Oracle tests, add ORACLE_USERNAME and ORACLE_PASSWORD as GitHub secrets."
            echo "Oracle Database Free is free for development and testing purposes."
            echo "Sign up at https://container-registry.oracle.com/"
          else
            echo "oracle_available=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Login to Oracle Container Registry (if pull failed)
        if: steps.try_oracle_pull.outcome == 'failure' && steps.check_oracle.outputs.oracle_available == 'true'
        run: |
          echo "${{ secrets.ORACLE_PASSWORD }}" | docker login container-registry.oracle.com -u "${{ secrets.ORACLE_USERNAME }}" --password-stdin || true
      
      - name: Start Oracle database
        if: steps.try_oracle_pull.outputs.oracle_available == 'true' || steps.check_oracle.outputs.oracle_available == 'true'
        working-directory: typedb-examples/integration_tests
        run: |
          docker compose up -d oracle
          echo "Waiting for Oracle to be ready..."
          timeout 300 bash -c 'until docker compose exec -T oracle sqlplus -S sys/password@localhost:1521/FREEPDB1 as sysdba <<< "SELECT 1 FROM DUAL;" &>/dev/null; do sleep 5; done' || exit 1
      
      - name: Run Oracle migrations
        if: steps.try_oracle_pull.outputs.oracle_available == 'true' || steps.check_oracle.outputs.oracle_available == 'true'
        working-directory: typedb-examples/integration_tests
        run: |
          docker compose run --rm migrate-oracle
      
      - name: Run Oracle integration tests
        if: steps.try_oracle_pull.outputs.oracle_available == 'true' || steps.check_oracle.outputs.oracle_available == 'true'
        working-directory: typedb-examples/integration_tests/oracle
        env:
          ORACLE_DSN: "oracle://typedb:password@localhost:1521/FREEPDB1"
        run: |
          go test -v
      
      - name: Cleanup Oracle container
        if: always() && (steps.try_oracle_pull.outputs.oracle_available == 'true' || steps.check_oracle.outputs.oracle_available == 'true')
        working-directory: typedb-examples/integration_tests
        run: |
          docker compose down -v oracle || true
      
      - name: Skip Oracle tests (no credentials)
        if: steps.try_oracle_pull.outcome == 'failure' && steps.check_oracle.outputs.oracle_available == 'false'
        run: |
          echo "Oracle tests skipped - credentials not configured"
          echo "This is not a failure. Oracle tests are optional."
