# Oracle Integration Tests

This directory contains comprehensive integration tests for using typedb with Oracle Database. These tests cover both **happy paths** (successful operations) and **negative paths** (error cases).

For simple example programs demonstrating the happy path, see [`../../examples/oracle/`](../../examples/oracle/).

## Prerequisites

- Oracle Database server (12c+)
- Go 1.18 or later
- Oracle driver: `github.com/sijms/go-ora/v2`

**Note:** Oracle requires Oracle Instant Client libraries to be installed.

## Setup

1. **Install Oracle Instant Client:**
   - Download from [Oracle website](https://www.oracle.com/database/technologies/instant-client/downloads.html)
   - Extract and add to your PATH (or set `LD_LIBRARY_PATH` on Linux)

2. **Install dependencies:**
   ```bash
   go get github.com/sijms/go-ora/v2
   ```

3. **Run migrations:**
   ```bash
   # Install golang-migrate (if not already installed)
   # macOS: brew install golang-migrate
   # Linux: See https://github.com/golang-migrate/migrate
   
   # Run migrations
   cd integration_tests/oracle
   migrate -path migrations -database "oracle://user:password@localhost:1521/XE" up
   ```

4. **Set environment variable (optional):**
   ```bash
   export ORACLE_DSN="oracle://user:password@localhost:1521/XE"
   ```

   Or use the default DSN: `oracle://user:password@localhost:1521/XE`

## Running Integration Tests

**Run all tests:**
```bash
go test -v
```

**Run with specific test:**
```bash
go test -v -run TestOracle_Load
```

**Note:** Tests will fail if database connection fails, ensuring databases are properly configured in CI/CD environments.

## Test Coverage

### Happy Path Tests
- ✅ Basic queries (`QueryAll`, `QueryFirst`, `QueryOne`)
- ✅ Model loading (`Load`, `LoadByField`, `LoadByComposite`)
- ✅ Transactions (`WithTx`)
- ✅ Oracle-specific features:
  - Named parameters (`:1`, `:2`)
  - JSON stored as CLOB
  - Composite keys

### Negative Path Tests
- ✅ Error handling for invalid queries
- ✅ Error handling for missing records
- ✅ Error handling for constraint violations
- ✅ Error handling for invalid data types

## Database Schema

The tests use three tables:

- **users** - User accounts with primary key and unique email
- **posts** - Blog posts with JSON stored as CLOB
- **user_posts** - Many-to-many relationship with composite key

See `schema.sql` for the complete schema definition.

## Differences from PostgreSQL/MySQL

- Uses named parameters (`:1`, `:2`) instead of `?` or `$1`
- Uses `NUMBER GENERATED BY DEFAULT AS IDENTITY` instead of `SERIAL` or `AUTO_INCREMENT`
- Uses `VARCHAR2` and `CLOB` for strings
- Uses `TIMESTAMP` for timestamps
- JSON stored as `CLOB` (no native JSON type in older versions)
- Requires Oracle Instant Client libraries

## Connection String Format

Oracle uses a URL format:
```
oracle://user:password@host:port/service_name
```

Example:
```
oracle://scott:tiger@localhost:1521/XE
```

## Oracle Instant Client

Oracle requires Instant Client libraries. Common installation paths:

- **Linux:** `/usr/lib/oracle/21/client64/lib`
- **macOS:** `/usr/local/lib`
- **Windows:** `C:\oracle\instantclient_21_3`

Set environment variables:
- **Linux/macOS:** `export LD_LIBRARY_PATH=/path/to/instantclient:$LD_LIBRARY_PATH`
- **Windows:** Add to PATH
